name: Deploy Site

on:
  # Trigger when build-site workflow completes
  pull_request:
    types: [closed]
    branches:
      - release

  # Optional manual trigger for testing/debugging
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (e.g., v0.2.0)'
        required: false
        type: string
      release_url_override:
        description: 'Override release URL'
        required: false
        type: string
      artifact_name_override:
        description: 'Override artifact name'
        required: false
        type: string

permissions:
  contents: write

jobs:
  deploy-site:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'workflow_dispatch'
    environment: production

    steps:
      - name: Validate secrets
        id: validate
        run: |
          MISSING_SECRETS=()

          # Check required secrets
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            MISSING_SECRETS+=("SSH_HOST")
          fi

          if [ -z "${{ secrets.SSH_USERNAME }}" ]; then
            MISSING_SECRETS+=("SSH_USERNAME")
          fi

          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          fi

          if [ -z "${{ secrets.ENV_SITE_ROOT_PATH }}" ]; then
            MISSING_SECRETS+=("ENV_SITE_ROOT_PATH")
          fi

          # Check if any secrets are missing
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "âš ï¸  Please configure the following secrets in repository settings:"
            echo "   Settings â†’ Secrets and variables â†’ Actions"
            echo ""
            echo "ðŸ“‹ Required secrets:"
            echo "  - SSH_HOST: Production server hostname"
            echo "  - SSH_USERNAME: SSH username"
            echo "  - SSH_PRIVATE_KEY: SSH private key for authentication"
            echo "  - SSH_PORT: SSH port (optional, defaults to 22)"
            echo "  - ENV_SITE_ROOT_PATH: Deployment directory on server"
            echo ""
            echo "ðŸ”— Documentation: .agent/DEPLOYMENT.md"
            echo ""
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âœ… All required secrets are configured"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Extract deployment info and check for artifacts
        if: steps.validate.outputs.should_deploy == 'true'
        id: info
        run: |
          # Extract deployment information
          VERSION=""
          RELEASE_URL=""
          ARTIFACT_NAME=""
          SOURCE="push"

          # Check if manual override is provided
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            VERSION="${{ github.event.inputs.version_override }}"
            echo "ðŸ“Œ Using manual version override: $VERSION"
          else
            # Always use latest release with site assets
            echo "ðŸ·ï¸  Getting latest released tag..."
            LATEST_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r '.tag_name')

            if [[ -n "$LATEST_TAG" && "$LATEST_TAG" != "null" ]]; then
              VERSION="$LATEST_TAG"
              echo "âœ… Found latest release tag: $VERSION"
            else
              echo "âŒ No release tags found in repository"
              echo "This deployment requires at least one published release tag"
              exit 1
            fi
          fi

          # Get release assets from the release
          echo "ðŸ” Checking for site assets in release: $VERSION..."
          RELEASE_ASSETS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION")

          # Look for the site tar.gz asset (with null safety)
          SITE_ASSET=$(echo "$RELEASE_ASSETS" | \
            jq -r '.assets[] | select(.name and (.name | contains("markly-site")) and (.name | endswith(".tar.gz")))')

          if [[ -n "$SITE_ASSET" && "$SITE_ASSET" != "null" ]]; then
            ARTIFACT_NAME=$(echo "$SITE_ASSET" | jq -r '.name')
            ARTIFACT_URL=$(echo "$SITE_ASSET" | jq -r '.browser_download_url')
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$VERSION"
            SOURCE="release"
            echo "âœ… Found site asset: $ARTIFACT_NAME"
            echo "ðŸ“¥ Download URL: ${ARTIFACT_URL:0:50}... (truncated for security)"
          else
            echo "âŒ No site assets found for release $VERSION"
            echo "ðŸ” DEBUG: Available assets:"
            echo "$RELEASE_ASSETS" | jq -r '.assets[] | select(.name) | .name' | head -5
            echo "This could mean:"
            echo "  - Release was created without site assets"
            echo "  - Site asset has different naming pattern"
            echo "  - Asset upload failed during release"
            exit 1
          fi

          # Output for use in later steps
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          echo "source=$SOURCE" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ Deployment Information:"
          echo "  Version: $VERSION"
          echo "  Release URL: $RELEASE_URL"
          echo "  Artifact: $ARTIFACT_NAME"
          echo "  Source: $SOURCE"

      - name: Deploy to server via SSH
        if: steps.validate.outputs.should_deploy == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          command_timeout: 60s
          envs: VERSION,RELEASE_URL,ARTIFACT_NAME,ARTIFACT_URL,TRIGGER_SOURCE,COMMIT_SHA,SITE_ROOT_PATH
          script: |
            # Set environment variables
            export VERSION="${{ steps.info.outputs.version }}"
            export RELEASE_URL="${{ steps.info.outputs.release_url }}"
            export ARTIFACT_NAME="${{ steps.info.outputs.artifact_name }}"
            export ARTIFACT_URL="${{ steps.info.outputs.artifact_url }}"
            export TRIGGER_SOURCE="${{ steps.info.outputs.source }}"
            export COMMIT_SHA="${{ github.sha }}"
            export SITE_ROOT_PATH="${{ secrets.ENV_SITE_ROOT_PATH }}"

            echo "ðŸš€ Starting Markly Site Deployment"
            echo "Version: $VERSION"
            echo "Source: $TRIGGER_SOURCE"
            echo "Artifact: $ARTIFACT_NAME"
            echo "Artifact URL: ${ARTIFACT_URL:0:50}... (truncated for security)"
            echo "Site Root Path: $SITE_ROOT_PATH"

            # Navigate to site root path
            cd "$SITE_ROOT_PATH"

            # Check if this is initial deployment
            IS_INITIAL_DEPLOYMENT=false
            if [ ! -d "public" ] && [ ! -d "backups" ]; then
              echo "ðŸ“ Detected initial deployment"
              IS_INITIAL_DEPLOYMENT=true
            fi

            # Backup current deployment if it exists
            if [ -d "public" ]; then
              echo "ðŸ“¦ Creating backup of current deployment..."
              BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
              sudo -u www mkdir -p "$SITE_ROOT_PATH/backups"
              sudo -u www cp -r "public" "$SITE_ROOT_PATH/backups/$BACKUP_NAME"
              echo "âœ… Backup created: $BACKUP_NAME"

              # Cleanup old backups (keep only 5 latest)
              echo "ðŸ§¹ Cleaning up old backups (keeping latest 5)..."
              sudo -u www bash -c "cd '$SITE_ROOT_PATH/backups' && ls -1t | tail -n +6 | xargs -r rm -rf"
              echo "âœ… Backup cleanup completed"
            else
              echo "â„¹ï¸ No existing public directory found to backup"
            fi

            # Clean up current public directory if exists
            if [ -d "public" ]; then
              echo "ðŸ§¹ Cleaning up current public directory..."
              sudo -u www rm -rf public/
              echo "âœ… Public directory cleanup completed"
            fi

            # Create deployment info
            echo "ðŸ“Š Creating deployment-info.json..."
            sudo -u www tee "deployment-info.json" > /dev/null <<EOF
            {
              "version": "$VERSION",
              "release_url": "$RELEASE_URL",
              "artifact_name": "$ARTIFACT_NAME",
              "trigger_source": "$TRIGGER_SOURCE",
              "commit_sha": "$COMMIT_SHA",
              "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "deployed_by": "github-actions",
              "site_root_path": "$SITE_ROOT_PATH"
            }
            EOF
            echo "âœ… Deployment info created: $SITE_ROOT_PATH/deployment-info.json"

            # Download artifact directly from GitHub to server
            echo "â¬‡ï¸  Downloading artifact: $ARTIFACT_NAME"
            echo "ðŸ” Using release asset download URL"
            echo "ðŸ“¡ Release asset: $ARTIFACT_NAME"
            echo "ðŸ”— Download URL: ${ARTIFACT_URL:0:50}... (truncated for security)"

            if [ -n "$ARTIFACT_URL" ]; then
              echo "âœ… Successfully found artifact download URL"
              echo "ðŸ“¥ Downloading artifact from release..."

              # Download release asset (public, no auth needed)
              ARTIFACT_FILE="artifact.tar.gz"
              echo "ðŸ“¦ Downloading release asset (tar.gz format)..."
              sudo -u www curl -L -f "$ARTIFACT_URL" -o "$ARTIFACT_FILE"

              # Check if download succeeded
              if [ ! -f "$ARTIFACT_FILE" ] || [ ! -s "$ARTIFACT_FILE" ]; then
                echo "âŒ Failed to download artifact"
                FILESIZE=$(stat -c%s "$ARTIFACT_FILE" 2>/dev/null || echo "0")
                echo "File size: $FILESIZE bytes"

                if [ "$IS_INITIAL_DEPLOYMENT" = false ]; then
                  echo "ðŸ”„ Restoring site from latest backup..."
                  LATEST_BACKUP=$(ls -1t "$SITE_ROOT_PATH/backups" 2>/dev/null | head -1)
                  if [[ -n "$LATEST_BACKUP" ]]; then
                    echo "ðŸ“¦ Restoring from backup: $LATEST_BACKUP"
                    sudo -u www cp -r "$SITE_ROOT_PATH/backups/$LATEST_BACKUP" "$SITE_ROOT_PATH/public"
                    echo "âœ… Site restored from backup successfully"
                  fi
                fi
                exit 1
              fi

              FILESIZE=$(stat -c%s "$ARTIFACT_FILE" 2>/dev/null || echo "unknown")
              echo "âœ… Downloaded artifact ($FILESIZE bytes)"

              # Extract artifact
              echo "ðŸ“‚ Extracting tar.gz artifact to $SITE_ROOT_PATH..."
              sudo -u www tar -xzf "$ARTIFACT_FILE"
              sudo -u www rm "$ARTIFACT_FILE"

              # Check if public directory exists (expected structure)
              if [ -d "public" ]; then
                echo "âœ… Artifact extracted successfully with public directory"
                echo "ðŸ“ Public directory contents:"
                ls -la public/ | head -10

                # Set proper permissions
                echo "ðŸ” Setting permissions..."
                sudo -u www find public -type d -exec chmod 755 {} \;
                sudo -u www find public -type f -exec chmod 644 {} \;
                echo "âœ… Permissions set"

                # Show deployment info from public directory
                if [ -f "public/deployment-info.json" ]; then
                  echo ""
                  echo "ðŸ“‹ Deployment Information:"
                  cat "public/deployment-info.json"
                fi

                # Mark initial deployment as successful
                if [ "$IS_INITIAL_DEPLOYMENT" = true ]; then
                  echo "ðŸŽ‰ Initial deployment completed successfully!"
                fi
              else
                echo "âš ï¸  Warning: No 'public' directory found in artifact"
                echo "ðŸ“ Current directory contents:"
                ls -la
                echo ""

                # Only try to restore if not initial deployment
                if [ "$IS_INITIAL_DEPLOYMENT" = false ]; then
                  echo "ðŸ”„ Restoring site from latest backup due to extraction failure..."
                  LATEST_BACKUP=$(ls -1t "$SITE_ROOT_PATH/backups" 2>/dev/null | head -1)

                  if [[ -n "$LATEST_BACKUP" ]]; then
                    echo "ðŸ“¦ Restoring from backup: $LATEST_BACKUP"
                    sudo -u www cp -r "$SITE_ROOT_PATH/backups/$LATEST_BACKUP" "$SITE_ROOT_PATH/public"
                    echo "âœ… Site restored from backup successfully"
                  else
                    echo "âš ï¸  No backups found to restore from"
                    echo "ðŸš¨ Site will be unavailable until manual intervention"
                  fi
                else
                  echo "âš ï¸ Initial deployment failed - no public directory in artifact"
                  echo "ðŸš¨ Please check the build process"
                fi

                echo "âŒ Deployment failed with exit code 1"
                exit 1
              fi
            else
              echo "âŒ Failed to get artifact download URL for: $ARTIFACT_NAME"
              echo "This could mean:"
              echo "  - Artifact doesn't exist"
              echo "  - GitHub token permissions insufficient"
              echo "  - Artifact has expired"
              echo "  - Artifact name mismatch"

              # Only try to restore if not initial deployment
              if [ "$IS_INITIAL_DEPLOYMENT" = false ]; then
                echo "ðŸ”„ Restoring site from latest backup..."
                LATEST_BACKUP=$(ls -1t "$SITE_ROOT_PATH/backups" 2>/dev/null | head -1)

                if [[ -n "$LATEST_BACKUP" ]]; then
                  echo "ðŸ“¦ Restoring from backup: $LATEST_BACKUP"
                  sudo -u www cp -r "$SITE_ROOT_PATH/backups/$LATEST_BACKUP" "$SITE_ROOT_PATH/public"
                  echo "âœ… Site restored from backup successfully"
                else
                  echo "âš ï¸  No backups found to restore from"
                  echo "ðŸš¨ Site will be unavailable until manual intervention"
                fi
              fi

              echo "âŒ Deployment failed with exit code 1"
              exit 1
            fi

            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“ Site files deployed to: $SITE_ROOT_PATH/public"
            echo "ðŸ“Š Deployment info saved to: $SITE_ROOT_PATH/deployment-info.json"

      - name: Deployment Summary
        if: steps.validate.outputs.should_deploy == 'true'
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Version**: ${{ steps.info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Release**: [${{ steps.info.outputs.version }}](${{ steps.info.outputs.release_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ steps.info.outputs.source }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: ${{ steps.info.outputs.artifact_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed At**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to**: markly.siaji.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Skipped Deployment Summary
        if: steps.validate.outputs.should_deploy == 'false'
        run: |
          echo "## âš ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment was skipped due to missing required secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please configure the following secrets in repository settings:" >> $GITHUB_STEP_SUMMARY
          echo "**Settings â†’ Secrets and variables â†’ Actions**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`SSH_HOST\` | Production server hostname |" >> $GITHUB_STEP_SUMMARY
          echo "| \`SSH_USERNAME\` | SSH username |" >> $GITHUB_STEP_SUMMARY
          echo "| \`SSH_PRIVATE_KEY\` | SSH private key for authentication |" >> $GITHUB_STEP_SUMMARY
          echo "| \`SSH_PORT\` | SSH port (optional, defaults to 22) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`ENV_SITE_ROOT_PATH\` | Deployment directory on server |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [\`.agent/DEPLOYMENT.md\`](.agent/DEPLOYMENT.md) for detailed setup instructions." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
